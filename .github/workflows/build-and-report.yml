name: Build + Update reccmp Report

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  fetch-deps:
    name: Download original binary
    uses: ./.github/workflows/cmr2bin.yml

  # build:
  #   name: Compile Visual Studio project with MSBuild
  #   needs: [fetch-deps]
  #   runs-on: "windows-latest"
  #   steps:
  #     - uses: actions/checkout@main
  #     - name: Build
  #       shell: cmd
  #       run: ${{ '"C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\VsDevCmd.bat" && msbuild /p:Platform=x86' }}
  #       working-directory: CMR2Decomp

  #     - name: Upload Artifact
  #       uses: actions/upload-artifact@main
  #       with:
  #         name: Win32
  #         path: |
  #           CMR2Decomp/Debug/CMR2.exe
  #           CMR2Decomp/Debug/CMR2.pdb

  build:
    name: Build (MSVC 6.0)
    needs: [fetch-deps]
    runs-on: "windows-latest"

    steps:
      - name: Fetch MSVC 6.0
        uses: actions/checkout@v4
        with:
          repository: itsmattkc/msvc600
          path: msvc600

      - name: Build
        shell: cmd
        run: call ./msvc600/bin/VCVARS32.BAT x86

      - name: Upload Build
        uses: actions/upload-artifact@main
        with:
          name: Win32
          path: |
            CMR2Decomp/Debug/CMR2.exe
            CMR2Decomp/Debug/CMR2.pdb

  verify:
    name: Verify decomp
    needs: [build, fetch-deps]
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@main

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: actions/download-artifact@main
        with:
          name: Win32
          path: build

      - name: Restore cached original binary
        id: cache-original-binary
        uses: actions/cache/restore@v4
        with:
          enableCrossOsArchive: true
          path: cmr2bin
          key: cmr2bin

      - name: Install python packages
        shell: bash
        run: |
          pip install git+https://github.com/isledecomp/reccmp
      - name: Detect binary
        run: |
          reccmp-project detect --what original   --search-path cmr2bin
          reccmp-project detect --what recompiled --search-path build
      - name: Summarize Accuracy
        shell: bash
        run: |
          reccmp-reccmp --target CMR2 --html index.html --json CMR2PROGRESS/summary.json

      - name: Compare Accuracy With Current main
        if: github.ref != 'refs/heads/main' # Only runs on not the 'main' branch
        shell: bash
        env:
          RELEASE_URL: https://raw.githubusercontent.com/CMR2Decomp/CMR2Decomp/refs/heads/main/CMR2PROGRESS/
        run: |
          # Download the current main state
          curl -fLSs -o summary-old.json $RELEASE_URL/summary.json || echo "" >summary-old.json

          # Compare with current main
          reccmp-reccmp --target CMR2 --diff summary-old.json || echo "Current master not found"

      - name: Test Exports
        shell: bash
        run: |
          reccmp-verexp --target CMR2

      # Don't have any vtables yet
      # - name: Check Vtables
      #   shell: bash
      #   run: |
      #     reccmp-vtable --target CMR2

      - name: Check Variables
        shell: bash
        run: |
          reccmp-datacmp --target CMR2

      - name: Commit Accuracy Reports
        if: github.ref == 'refs/heads/main' # Only runs on the 'main' branch
        shell: bash
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add index.html CMR2PROGRESS/summary.json
          git commit -m "chore: update accuracy reports"
          git push
